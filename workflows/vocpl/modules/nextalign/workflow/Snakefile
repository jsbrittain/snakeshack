configfile: "config/config.yaml"

from pathlib import Path

rule nextalign:
    input:
        expand(
            "results/{indir}/s{{key}}/{infile}",
            indir=config["input_namespace"],
            infile=config["params"]["subsample_prealign_fasta"],
        ),
    output:
        expand(
            "results/{outdir}/s{{key}}/nextalign.aligned.fasta",
            outdir=config["output_namespace"],
        ),
    params:
        reference=config["params"]["reference"],
        genemap=config["params"]["genemap"],
        genes=config["params"]["genes"],
        outdir = lambda wildcards, output: Path(output[0]).parent
    conda:
        "envs/conda.yaml"
    shell:
        """
        nextalign run \
            --input-ref={params.reference} \
            --genemap={params.genemap} \
            --genes={params.genes} \
            --output-all={params.outdir} \
            {input}
        """
